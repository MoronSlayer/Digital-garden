<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Frank+Ruhl+Libre:wght@200;300;400;500;600&family=Encode+Sans+Semi+Condensed:wght@400&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/Digital-garden/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/Digital-garden/css/all.min.css><link disabled id=dark-mode-theme rel=stylesheet href=/Digital-garden/css/dark.css><link rel=stylesheet type=text/css href=/Digital-garden/css/style.css><link rel=stylesheet type=text/css href=/Digital-garden/css/my_style.css><title>My Digital Garden | RAG: Chat with data</title><meta name=description content="RAG with LangChain"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class=container><a class=navbar-brand href=https://ritesh1137.github.io/Digital-garden/><b style=font-weight:800>RP</b></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class=nav-link href=/Digital-garden/garden/>Digital Garden</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/projects/>Projects</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/library/>Library</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/about/>About</a></li><li class="nav-item px-2 pt-1"><a class="btn fas fa-moon" id=dark-mode-toggle></a></li></ul></div></div></nav><div id=content><div class=container style=max-width:800px><div class="py-4 rounded-3"><div class="container-fluid py-2"><h1 class="display-2 mb-4 text-center">RAG: Chat with data</h1></div><p class="text-center fs-4 fst-italic serif">RAG with LangChain</p><div class="text-center pt-4"></div></div><div class="row justify-content-center mb-5"><div class=col-12><p class="card-date m-0">Created Feb 16, 2024 -
Last updated: Feb 17, 2024</p><hr class=dropdown-divider><div class="row justify-content-between"><div class=col-sm-4><span class=status>Seeding ðŸŒ±</span></div><div class=col-sm-8 style=text-align:right><span onclick='handleTagClick("large-language-models","garden")' class="badge tag-badge">large-language-models</span></div></div></div></div><div class="container-fluid py-2"><div class="serif main-content"><h1 id=rag>RAG</h1><p>Retrieval Augmented Generation(RAG) is a popular process to establish a connection with any local data source to large language models as shown in the diagram below.<figure><img src=./RAG.png width=100%></figure></p><p>We shall see the process of constructing these applications and go through the steps listed in the diagram. You can also code along. We will be working with the OpenAI api, but any LLM can be used.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>openai</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span>
</span></span><span style=display:flex><span><span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>path</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#d88200>&#39;../..&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>dotenv</span> <span style=color:#f92672>import</span> <span style=color:#111>load_dotenv</span><span style=color:#111>,</span> <span style=color:#111>find_dotenv</span>
</span></span><span style=display:flex><span><span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>load_dotenv</span><span style=color:#111>(</span><span style=color:#111>find_dotenv</span><span style=color:#111>())</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>openai</span><span style=color:#f92672>.</span><span style=color:#111>api_key</span>  <span style=color:#f92672>=</span> <span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#d88200>&#39;OPENAI_API_KEY&#39;</span><span style=color:#111>]</span>
</span></span></code></pre></div><h2 id=step-1---document-loaders>Step 1 - Document loaders</h2><p>The first step to chat with any kind of data source you might have is to bring your data sources into a format that can be work with. Document loaders help with this task.</p><p>Some examples are listed</p><h4 id=pdfs>PDFs</h4><p><a href=https://see.stanford.edu/materials/aimlcs229/transcripts/MachineLearning-Lecture01.pdf>Here is a demo pdf you can work with</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>PyPDFLoader</span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/Lecture_notes.pdf&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pages</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>pages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>page</span> <span style=color:#f92672>=</span> <span style=color:#111>pages</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>page</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span>
</span></span></code></pre></div><p>Each page is a <code>Document</code>.</p><p>A <code>Document</code> contains text (<code>page_content</code>) and <code>metadata</code>.</p><h4 id=youtube-videos>Youtube videos</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>yt_dlp</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>pydub</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders.generic</span> <span style=color:#f92672>import</span> <span style=color:#111>GenericLoader</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders.parsers</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAIWhisperParser</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders.blob_loaders.youtube_audio</span> <span style=color:#f92672>import</span> <span style=color:#111>YoutubeAudioLoader</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>url</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;https://www.youtube.com/watch?v=jGwO_UgTS7I&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>save_dir</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;docs/youtube/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>GenericLoader</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>YoutubeAudioLoader</span><span style=color:#111>([</span><span style=color:#111>url</span><span style=color:#111>],</span><span style=color:#111>save_dir</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>OpenAIWhisperParser</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>:</span><span style=color:#ae81ff>500</span><span style=color:#111>]</span>
</span></span></code></pre></div><h4 id=urls>URLs</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>WebBaseLoader</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>WebBaseLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;https://github.com/basecamp/handbook/blob/master/37signals-is-you.md&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[:</span><span style=color:#ae81ff>500</span><span style=color:#111>])</span>
</span></span></code></pre></div><h4 id=notion>Notion</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>NotionDirectoryLoader</span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>NotionDirectoryLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/Notion_DB&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>:</span><span style=color:#ae81ff>200</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span>
</span></span></code></pre></div><h2 id=step-2---document-splitting>Step 2 - Document Splitting</h2><p>For large documents, they need to be split into chunks to make it more easy for the model to understand your data.</p><figure><img src=./chunk_basics.png width=100%></figure><p>As seen above, the basics in langchain involve splitting on some chunks in some chunk size with some chunk overlap.</p><p>There are different kinds of text splitters in langchain, based on various factors. They can vary on how they split the chunks, what characters go into that. They can vary on how they measure the length of the chunks.
Is it by characters? Is it by tokens? There are even some that use other smaller models to determine when the end of a sentence might be and use that as a way of splitting chunks. Another important part of splitting into chunks is also the metadata. Maintaining the same metadata across all chunks, but also adding in new pieces of metadata when relevant, and so there are some text splitters that are really focused on that. There are also some splitters based on specific programming languages such as Python or Ruby that take into account the semantics of the language.</p><h5 id=heres-an-example-with-some-popular-splitters-recursivecharactertextsplitter-and-charactertextsplitter>Here&rsquo;s an example with some popular splitters, <code>RecursiveCharacterTextSplitter</code> and <code>CharacterTextSplitter</code></h5><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>,</span> <span style=color:#111>CharacterTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#111>chunk_size</span> <span style=color:#f92672>=</span><span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span><span style=color:#111>chunk_overlap</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#111>chunk_size</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#111>chunk_overlap</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>c_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>CharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#111>chunk_size</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#111>chunk_overlap</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>text1</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>text2</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;abcdefghijklmnopqrstuvwxyzabcdefg&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>text3</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;a b c d e f g h i j k l m n o p q r s t u v w x y z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>We can see that text1 is not split as it is 26 letters and our chunk size is 26</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>c_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Now we see that the character is not split, the reason is that CharacterTextSplitter splits by characters and by deafult that means on new lines, to overcome this we can set the separator to an empty space.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>c_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>CharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#111>chunk_size</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#111>chunk_overlap</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>separator</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39; &#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>c_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>This works now!</p><p><code>RecursiveCharacterTextSplitter`</code> is recommended for generic text</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>some_text</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;When writing documents, writers will use document structure to group content. </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>This can convey to the reader, which idea&#39;s are related. For example, closely related ideas </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>are in sentances. Similar ideas are in paragraphs. Paragraphs form a document. </span><span style=color:#8045ff>\n\n</span><span style=color:#d88200>  </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Paragraphs are often delimited with a carriage return or two carriage returns. </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Carriage returns are the &#34;backslash n&#34; you see embedded in this string. </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Sentences have a period at the end, but also, have a space.</span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>and words are separated by space.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>c_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>CharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>450</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>separator</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39; &#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>450</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>separators</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34; &#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>c_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>some_text</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>some_text</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>You can reduce the chunk size and experiment.</p><p>We can also set complex regex in the separators for more legible chunking</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>r_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>150</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>separators</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;(?&lt;=\. )&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34; &#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>r_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>some_text</span><span style=color:#111>)</span>
</span></span></code></pre></div><h5 id=now-for-documents>Now for documents,</h5><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>PyPDFLoader</span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/Lecture.pdf&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pages</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>CharacterTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>CharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>separator</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>150</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>length_function</span><span style=color:#f92672>=</span><span style=color:#111>len</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_documents</span><span style=color:#111>(</span><span style=color:#111>pages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>pages</span><span style=color:#111>)</span>
</span></span></code></pre></div><h5 id=we-can-also-split-based-on-tokens-explicitly-which-are-how-llms-are-based-on>We can also split based on tokens explicitly, which are how LLMs are based on:</h5><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>TokenTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>TokenTextSplitter</span><span style=color:#111>(</span><span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>text1</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;foo bar bazzyfoo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>text1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>TokenTextSplitter</span><span style=color:#111>(</span><span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_documents</span><span style=color:#111>(</span><span style=color:#111>pages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>pages</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span>
</span></span></code></pre></div><h5 id=context-aware-chunking>Context-aware chunking</h5><p>Chunking aims to keep text with common context together.</p><p>A text splitting often uses sentences or other delimiters to keep related text together but many documents (such as Markdown) have structure (headers) that can be explicitly used in splitting.</p><p>We can use MarkdownHeaderTextSplitter to preserve header metadata in our chunks, as show below</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>NotionDirectoryLoader</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>MarkdownHeaderTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#111>markdown_document</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;# Title</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>## Chapter 1</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Hi this is Jim</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> Hi this is Joe</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>### Section </span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Hi this is Lance </span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> 
</span></span></span><span style=display:flex><span><span style=color:#d88200>## Chapter 2</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200> </span><span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span><span style=color:#d88200>Hi this is Ritesh&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>headers_to_split_on</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>    <span style=color:#111>(</span><span style=color:#d88200>&#34;#&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Header 1&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>(</span><span style=color:#d88200>&#34;##&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Header 2&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>(</span><span style=color:#d88200>&#34;###&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Header 3&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>markdown_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>MarkdownHeaderTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>headers_to_split_on</span><span style=color:#f92672>=</span><span style=color:#111>headers_to_split_on</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>md_header_splits</span> <span style=color:#f92672>=</span> <span style=color:#111>markdown_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>markdown_document</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>md_header_splits</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>md_header_splits</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>The header data is used for seeing where to split and it is saved in the metadata for referencing later.</p><h2 id=step-3---vector-stores-and-embeddings>Step 3 - Vector Stores and Embeddings</h2><p>Now, with semantically meaningfully split chunks of our documents, we can put them into an index so that we can retrieve them easily when we have answer questions about them.</p><p>Embeddings/vectors capture semantic meaning in our text. Text with similar meaning will have similar embeddings.</p><figure><img src=./embedding_vecs.png width=100%></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>PyPDFLoader</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load PDF</span>
</span></span><span style=display:flex><span><span style=color:#111>loaders</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Duplicate documents on purpose - messy data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture01.pdf&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture01.pdf&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture02.pdf&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture03.pdf&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>loader</span> <span style=color:#f92672>in</span> <span style=color:#111>loaders</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>docs</span><span style=color:#f92672>.</span><span style=color:#111>extend</span><span style=color:#111>(</span><span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Split</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>RecursiveCharacterTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1500</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chunk_overlap</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>splits</span> <span style=color:#f92672>=</span> <span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_documents</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>splits</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now we can take our splits and embed them</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.embeddings.openai</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAIEmbeddings</span>
</span></span><span style=display:flex><span><span style=color:#111>embedding</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAIEmbeddings</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>sentence1</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;i like dogs&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>sentence2</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;i like canines&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>sentence3</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;the weather is ugly outside&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>embedding1</span> <span style=color:#f92672>=</span> <span style=color:#111>embedding</span><span style=color:#f92672>.</span><span style=color:#111>embed_query</span><span style=color:#111>(</span><span style=color:#111>sentence1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>embedding2</span> <span style=color:#f92672>=</span> <span style=color:#111>embedding</span><span style=color:#f92672>.</span><span style=color:#111>embed_query</span><span style=color:#111>(</span><span style=color:#111>sentence2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>embedding3</span> <span style=color:#f92672>=</span> <span style=color:#111>embedding</span><span style=color:#f92672>.</span><span style=color:#111>embed_query</span><span style=color:#111>(</span><span style=color:#111>sentence3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span> <span style=color:#00a8c8>as</span> <span style=color:#111>np</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>dot</span><span style=color:#111>(</span><span style=color:#111>embedding1</span><span style=color:#111>,</span> <span style=color:#111>embedding2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>dot</span><span style=color:#111>(</span><span style=color:#111>embedding1</span><span style=color:#111>,</span> <span style=color:#111>embedding3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>dot</span><span style=color:#111>(</span><span style=color:#111>embedding2</span><span style=color:#111>,</span> <span style=color:#111>embedding3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>We will see that the do product of sentence 1 and 2 is the highest as it corresponds to similar sentences.</p><p>In a vector store, we create embeddings our document and store them. Then when we have questions that we want to ask the documents through our LLMs, our question to the LLM passes as embeddings back to the vector store to retrieve the &lsquo;k&rsquo; most relevant documents related to our question.</p><figure><img src=./create_embeddings.png width=100%></figure><figure><img src=./index_embeddings.png width=100%></figure><p>Now, let&rsquo;s explore this process with an open source lightweight, in-memory vector store, Chroma.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>chromadb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.vectorstores</span> <span style=color:#f92672>import</span> <span style=color:#111>Chroma</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#persist directory is where our vector store will be saved which can be reused later on </span>
</span></span><span style=display:flex><span><span style=color:#111>persist_directory</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;docs/chroma/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>!</span><span style=color:#111>rm</span> <span style=color:#f92672>-</span><span style=color:#111>rf</span> <span style=color:#f92672>./</span><span style=color:#111>docs</span><span style=color:#f92672>/</span><span style=color:#111>chroma</span>  <span style=color:#75715e># remove old database files if any</span>
</span></span><span style=display:flex><span><span style=color:#111>vectordb</span> <span style=color:#f92672>=</span> <span style=color:#111>Chroma</span><span style=color:#f92672>.</span><span style=color:#111>from_documents</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>documents</span><span style=color:#f92672>=</span><span style=color:#111>splits</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>embedding</span><span style=color:#f92672>=</span><span style=color:#111>embedding</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>persist_directory</span><span style=color:#f92672>=</span><span style=color:#111>persist_directory</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>_collection</span><span style=color:#f92672>.</span><span style=color:#111>count</span><span style=color:#111>())</span>
</span></span></code></pre></div><p>Now, coming to the similarity search part</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;is there an email i can ask for help&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># to save this for later use </span>
</span></span><span style=display:flex><span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>persist</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>Although this is great, and similarity search works well, there can be edge cases that creep up.
Suppose we have a query such as</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about matlab?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>This query might return the same chunks in the search as they might contain the same documents twice or more. Because the same information lies in two different chunks, we get issues. Semantic search fetches all similar documents, but does not enforce diversity. It would be much better if there if there is a different, distinct chunk that our model can learn from.</p><p>Another type of failure is seen below</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about regression in the third lecture?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>doc</span> <span style=color:#f92672>in</span> <span style=color:#111>docs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>doc</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Here the question is from lecture three but we also get other lectures in our results which don&rsquo;t contain information about regression. We will adress these issues next</p><h2 id=step-4---retrieval>Step 4 - Retrieval</h2><p>Retrieval is the centerpiece of our retrieval augmented generation (RAG) flow.</p><p>Below is the common code used to load our vector store for all tasks in retrieval.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>lark</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##  here, we load the vector database just as we did previously</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.vectorstores</span> <span style=color:#f92672>import</span> <span style=color:#111>Chroma</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.embeddings.openai</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAIEmbeddings</span>
</span></span><span style=display:flex><span><span style=color:#111>persist_directory</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;docs/chroma/&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>embedding</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAIEmbeddings</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>vectordb</span> <span style=color:#f92672>=</span> <span style=color:#111>Chroma</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>persist_directory</span><span style=color:#f92672>=</span><span style=color:#111>persist_directory</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>embedding_function</span><span style=color:#f92672>=</span><span style=color:#111>embedding</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>_collection</span><span style=color:#f92672>.</span><span style=color:#111>count</span><span style=color:#111>())</span>
</span></span></code></pre></div><p>Some of the more advanced methods for retrieval include:</p><h4 id=maximal-marginal-retrieval><strong>Maximal marginal retrieval</strong></h4><ul><li>You may not always want to choose most similar responses, so that you don&rsquo;t lose diverse information.</li></ul><p>for e.g: A chef asks about white mushrooms that are fruiting, it results two results about Amanita phalloides. But the third result contains information that this mushroom is actually poisonous, but is not retrieved as it is not as relevant to the query the chef asked.</p><p>MMR comes into play here, where divergence comes into play.</p><figure><img src=./MMR.png width=100%></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>texts</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34;The Amanita phalloides has a large and imposing epigeous (aboveground) fruiting body (basidiocarp).&#34;&#34;&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34;A mushroom with a large fruiting body is the Amanita phalloides. Some varieties are all-white.&#34;&#34;&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34;A. phalloides, a.k.a Death Cap, is one of the most poisonous of all known mushrooms.&#34;&#34;&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>smalldb</span> <span style=color:#f92672>=</span> <span style=color:#111>Chroma</span><span style=color:#f92672>.</span><span style=color:#111>from_texts</span><span style=color:#111>(</span><span style=color:#111>texts</span><span style=color:#111>,</span> <span style=color:#111>embedding</span><span style=color:#f92672>=</span><span style=color:#111>embedding</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Tell me about all-white mushrooms with large fruiting bodies&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>smalldb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>smalldb</span><span style=color:#f92672>.</span><span style=color:#111>max_marginal_relevance_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#111>fetch_k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Also, in one of the previous examples, we saw how our model returned multiple irrelevant docs when asked about regression. Now, we can use MMR.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about matlab?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_ss</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_ss</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[:</span><span style=color:#ae81ff>100</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_ss</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[:</span><span style=color:#ae81ff>100</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now, see the differnce with MMR</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>docs_mmr</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>max_marginal_relevance_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_mmr</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[:</span><span style=color:#ae81ff>100</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_mmr</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span><span style=color:#111>[:</span><span style=color:#ae81ff>100</span><span style=color:#111>]</span>
</span></span></code></pre></div><h4 id=llm-aided-retrieval-selfquery><strong>LLM aided retrieval/ SelfQuery</strong></h4><p>This is useful when we have questions that aren&rsquo;t related just to the questions that we ask semantically but also have some reference to the metadata that we want to do a filter on.</p><figure><img src=./llm_aided.png width=100%></figure><p>Here we have the semantic context of aliens and metadata for 1980. What we can do is an LLM itself to split the question into two parts, a metadata filter and a search term.</p><p>In a previous example, we saw that a question about the third lecture can include results from other lectures as well. To address this, many vectorstores support operations on metadata. Metadata provides context for each embedded chunk.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about regression in the third lecture?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>question</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>filter</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#34;source&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture03.pdf&#34;</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>d</span> <span style=color:#f92672>in</span> <span style=color:#111>docs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><strong>Addressing Specificity: working with metadata using self-query retriever</strong></p><p>But we have an interesting challenge: we often want to infer the metadata from the query itself, not do it manually.</p><p>To address this, we can use <code>SelfQueryRetriever</code>, which uses an LLM to extract:</p><ol><li>The <code>query</code> string to use for vector search</li><li>A metadata filter to pass in as well</li></ol><p>Most vector databases support metadata filters, so this doesn&rsquo;t require any new databases or indexes.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.llms</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.retrievers.self_query.base</span> <span style=color:#f92672>import</span> <span style=color:#111>SelfQueryRetriever</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chains.query_constructor.base</span> <span style=color:#f92672>import</span> <span style=color:#111>AttributeInfo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>metadata_field_info</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>    <span style=color:#111>AttributeInfo</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;source&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>description</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;The lecture the chunk is from, should be one of `docs/cs229_lectures/MachineLearning-Lecture01.pdf`, `docs/cs229_lectures/MachineLearning-Lecture02.pdf`, or `docs/cs229_lectures/MachineLearning-Lecture03.pdf`&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;string&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>AttributeInfo</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;page&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>description</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;The page from the lecture&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;integer&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>),</span>
</span></span><span style=display:flex><span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>document_content_description</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Lecture notes&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>llm</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAI</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;gpt-3.5-turbo-instruct&#39;</span><span style=color:#111>,</span> <span style=color:#111>temperature</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>SelfQueryRetriever</span><span style=color:#f92672>.</span><span style=color:#111>from_llm</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>vectordb</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>document_content_description</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>metadata_field_info</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>verbose</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about regression in the third lecture?&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>retriever</span><span style=color:#f92672>.</span><span style=color:#111>get_relevant_documents</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>d</span> <span style=color:#f92672>in</span> <span style=color:#111>docs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#f92672>.</span><span style=color:#111>metadata</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>The metadata_info is passed onto our LLMs, so it is important to be as specific as possible.</p><h4 id=compression><strong>Compression</strong></h4><p>Compression is useful to pull only the most relevant splits of the retrieved package.
Information most relevant to a query may be buried in a document with a lot of irrelevant text.
Passing that full document through your application can lead to more expensive LLM calls and poorer responses.
Contextual compression is meant to fix this.</p><p><figure><img src=./compression.png width=100%></figure>As seen in the image above, our intial question might return the entire documents that were stored even though we need only one or two documents. With compression, we can run all those documents into a compression LLM and get only the most relevant documents passed to the final LLM. This comes at a cost of more calls to the LLM but it is useful for getting only the most relevant parts.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.retrievers</span> <span style=color:#f92672>import</span> <span style=color:#111>ContextualCompressionRetriever</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.retrievers.document_compressors</span> <span style=color:#f92672>import</span> <span style=color:#111>LLMChainExtractor</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>pretty_print_docs</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>{</span><span style=color:#d88200>&#39;-&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span><span style=color:#d88200>}</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>([</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Document </span><span style=color:#d88200>{</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#d88200>}</span><span style=color:#d88200>:</span><span style=color:#8045ff>\n\n</span><span style=color:#d88200>&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>d</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span> <span style=color:#00a8c8>for</span> <span style=color:#111>i</span><span style=color:#111>,</span> <span style=color:#111>d</span> <span style=color:#f92672>in</span> <span style=color:#111>enumerate</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>)]))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wrap our vectorstore</span>
</span></span><span style=display:flex><span><span style=color:#111>llm</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAI</span><span style=color:#111>(</span><span style=color:#111>temperature</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>compressor</span> <span style=color:#f92672>=</span> <span style=color:#111>LLMChainExtractor</span><span style=color:#f92672>.</span><span style=color:#111>from_llm</span><span style=color:#111>(</span><span style=color:#111>llm</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>compression_retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>ContextualCompressionRetriever</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>base_compressor</span><span style=color:#f92672>=</span><span style=color:#111>compressor</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>base_retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about matlab?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>compressed_docs</span> <span style=color:#f92672>=</span> <span style=color:#111>compression_retriever</span><span style=color:#f92672>.</span><span style=color:#111>get_relevant_documents</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pretty_print_docs</span><span style=color:#111>(</span><span style=color:#111>compressed_docs</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>In the example above, we will see two things. First, the documents are a lot shorter, which is good but there also repeated documents because under the hood we still use semantic search. This can be solved using MMR.</p><p>To solve this, we can combine these two methods to get best results</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>compression_retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>ContextualCompressionRetriever</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>base_compressor</span><span style=color:#f92672>=</span><span style=color:#111>compressor</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>base_retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(</span><span style=color:#111>search_type</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;mmr&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about matlab?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>compressed_docs</span> <span style=color:#f92672>=</span> <span style=color:#111>compression_retriever</span><span style=color:#f92672>.</span><span style=color:#111>get_relevant_documents</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pretty_print_docs</span><span style=color:#111>(</span><span style=color:#111>compressed_docs</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Now we get a filtered set of results without any duplicate information.</p><p>There are some other types of retrieval in langchain that don&rsquo;t use vector databases at all, such as TF-IDF or SVM which are more traditional NLP techniques.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.retrievers</span> <span style=color:#f92672>import</span> <span style=color:#111>SVMRetriever</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.retrievers</span> <span style=color:#f92672>import</span> <span style=color:#111>TFIDFRetriever</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>PyPDFLoader</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>RecursiveCharacterTextSplitter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load PDF</span>
</span></span><span style=display:flex><span><span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture01.pdf&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pages</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>all_page_text</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>page_content</span> <span style=color:#00a8c8>for</span> <span style=color:#111>p</span> <span style=color:#f92672>in</span> <span style=color:#111>pages</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>joined_page_text</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34; &#34;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>(</span><span style=color:#111>all_page_text</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Split</span>
</span></span><span style=display:flex><span><span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span><span style=color:#111>chunk_size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1500</span><span style=color:#111>,</span><span style=color:#111>chunk_overlap</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>150</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>splits</span> <span style=color:#f92672>=</span> <span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_text</span><span style=color:#111>(</span><span style=color:#111>joined_page_text</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Retrieve</span>
</span></span><span style=display:flex><span><span style=color:#111>svm_retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>SVMRetriever</span><span style=color:#f92672>.</span><span style=color:#111>from_texts</span><span style=color:#111>(</span><span style=color:#111>splits</span><span style=color:#111>,</span><span style=color:#111>embedding</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>tfidf_retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>TFIDFRetriever</span><span style=color:#f92672>.</span><span style=color:#111>from_texts</span><span style=color:#111>(</span><span style=color:#111>splits</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;What are major topics for this class?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_svm</span><span style=color:#f92672>=</span><span style=color:#111>svm_retriever</span><span style=color:#f92672>.</span><span style=color:#111>get_relevant_documents</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_svm</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;what did they say about matlab?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_tfidf</span><span style=color:#f92672>=</span><span style=color:#111>tfidf_retriever</span><span style=color:#f92672>.</span><span style=color:#111>get_relevant_documents</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>docs_tfidf</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span></code></pre></div><h2 id=step-5---question-answering>Step 5 - Question Answering</h2><p>Now, after we retrieve documents, potentially compressing the relevant chunks to fit into the LLM context; we send the information along with our question to an LLM to select and format an answer.</p><p>We can see the general flow of an information retrieval question answering system below:</p><figure><img src=./retrieval_qa.png width=100%></figure><p>We get a question, retrieve the most relevant documents in splits and send that as the system prompt along with the original human prompt to the LLM to get an answer.</p><p>By default we pass all the chunks into the same context window, into the same call with the language model.</p><p>Some of the advantages are offered in situations where all of the documents simply can&rsquo;t fit inside the context window. The above listed techniques are useful to get around this issue of short context windows.</p><p>Let&rsquo;s look at the basic process of building a retrieval QA system with code.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We load the vector database that we created earlier</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.vectorstores</span> <span style=color:#f92672>import</span> <span style=color:#111>Chroma</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.embeddings.openai</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAIEmbeddings</span>
</span></span><span style=display:flex><span><span style=color:#111>persist_directory</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;docs/chroma/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>embedding</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAIEmbeddings</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>vectordb</span> <span style=color:#f92672>=</span> <span style=color:#111>Chroma</span><span style=color:#111>(</span><span style=color:#111>persist_directory</span><span style=color:#f92672>=</span><span style=color:#111>persist_directory</span><span style=color:#111>,</span> <span style=color:#111>embedding_function</span><span style=color:#f92672>=</span><span style=color:#111>embedding</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d88200>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>If you have been using the same data, you can see that the collection count always 
</span></span></span><span style=display:flex><span><span style=color:#d88200>remains constant as we are not adding any additional documents to our vector store.
</span></span></span><span style=display:flex><span><span style=color:#d88200>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>_collection</span><span style=color:#f92672>.</span><span style=color:#111>count</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;What are major topics for this class?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>similarity_search</span><span style=color:#111>(</span><span style=color:#111>question</span><span style=color:#111>,</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chat_models</span> <span style=color:#f92672>import</span> <span style=color:#111>ChatOpenAI</span>
</span></span><span style=display:flex><span><span style=color:#111>llm</span> <span style=color:#f92672>=</span> <span style=color:#111>ChatOpenAI</span><span style=color:#111>(</span><span style=color:#111>model_name</span><span style=color:#f92672>=</span><span style=color:#111>llm_name</span><span style=color:#111>,</span> <span style=color:#111>temperature</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now the RetrievalQA chain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chains</span> <span style=color:#f92672>import</span> <span style=color:#111>RetrievalQA</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>qa_chain</span> <span style=color:#f92672>=</span> <span style=color:#111>RetrievalQA</span><span style=color:#f92672>.</span><span style=color:#111>from_chain_type</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa_chain</span><span style=color:#111>({</span><span style=color:#d88200>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;result&#34;</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>To get some insights into what&rsquo;s happening under the hood, and understand which knobs we can turn.</p><p>The main part that&rsquo;s important here is the prompt, which will take in the documents and the question and pass it to the LLM.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.prompts</span> <span style=color:#f92672>import</span> <span style=color:#111>PromptTemplate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build prompt</span>
</span></span><span style=display:flex><span><span style=color:#111>template</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;Use the following pieces of context to answer the question at the end. If you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer. Use three sentences maximum. Keep the answer as concise as possible. Always say &#34;thanks for asking!&#34; at the end of the answer. 
</span></span></span><span style=display:flex><span><span style=color:#d88200></span><span style=color:#d88200>{context}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Question: </span><span style=color:#d88200>{question}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Helpful Answer:&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>QA_CHAIN_PROMPT</span> <span style=color:#f92672>=</span> <span style=color:#111>PromptTemplate</span><span style=color:#f92672>.</span><span style=color:#111>from_template</span><span style=color:#111>(</span><span style=color:#111>template</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run chain</span>
</span></span><span style=display:flex><span><span style=color:#111>qa_chain</span> <span style=color:#f92672>=</span> <span style=color:#111>RetrievalQA</span><span style=color:#f92672>.</span><span style=color:#111>from_chain_type</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>return_source_documents</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chain_type_kwargs</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#34;prompt&#34;</span><span style=color:#111>:</span> <span style=color:#111>QA_CHAIN_PROMPT</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Is probability a class topic?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa_chain</span><span style=color:#111>({</span><span style=color:#d88200>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;result&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;source_documents&#34;</span><span style=color:#111>][</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>This is the vanilla way of doing things, stuff all the documents into the final prompt.</p><p>But if there are too many documents, they may not be able to fit into the context window.</p><h4 id=map-reduce><strong>Map Reduce</strong></h4><figure><img src=./retrieval_qa_map_reduce.png width=100%></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>qa_chain_mr</span> <span style=color:#f92672>=</span> <span style=color:#111>RetrievalQA</span><span style=color:#f92672>.</span><span style=color:#111>from_chain_type</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chain_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;map_reduce&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa_chain_mr</span><span style=color:#111>({</span><span style=color:#d88200>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>   
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;result&#34;</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>In this technique, each of the document is sent to the LLM to get an original answer. Then all induvidual anaswers are re-sent to the LLM to get a final call as the final answer, based upon induvidual answers of each document.</p><p>This involves a lot of calls to the language model, but it does have the advantage that we can use an arbitrarily large number of documents.</p><p>Another limitation to it being slower due to many more calls to the LLM is that it can be worse if there is no answer because the question we ask has information spread across two documents and the knowledge is limited to one document at a time. It doesn&rsquo;t have all information in the same context.</p><p>We can use LangChain plus to get access to LangSmith and see what&rsquo;s happening under the hood.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># set environment variables</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LANGCHAIN_TRACING_V2&#34;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;true&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LANGCHAIN_ENDPOINT&#34;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;https://api.langchain.plus&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LANGCHAIN_API_KEY&#34;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># re-run the map-reduce chain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>qa_chain_mr</span> <span style=color:#f92672>=</span> <span style=color:#111>RetrievalQA</span><span style=color:#f92672>.</span><span style=color:#111>from_chain_type</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chain_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;map_reduce&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa_chain_mr</span><span style=color:#111>({</span><span style=color:#d88200>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;result&#34;</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>In LangSmith UI we can see the run, and by selecting it we can see the input and the output. We can also see the child runs to analyze what&rsquo;s happening under the hood. Below, we see the the MapReduceChain involves four separate calls to the LLM.</p><figure><img src=./retrieval_qa_map_reduce_langsmith.png width=100%></figure><p>If we click any of the calls, we will in-turn see that we have the input and the output for each of the documents.</p><p>Going back to our run, we can see that after it&rsquo;s run over each of these documents it&rsquo;s combined in a final chain, the StuffDocumentsChain where it stuffed all these responses into the final call.</p><p>Clicking the StuffDocumentsChain we can see that we have the system message, the summaries of the four documents and the final answer.</p><figure><img src=./retrieval_qa_map_reduce_langsmith_run.gif width=100%></figure><h4 id=refine><strong>Refine</strong></h4><p>We can do a similar thing using refine.</p><figure><img src=./retrieval_qa_refine.png width=100%></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>qa_chain_mr</span> <span style=color:#f92672>=</span> <span style=color:#111>RetrievalQA</span><span style=color:#f92672>.</span><span style=color:#111>from_chain_type</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chain_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;refine&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa_chain_mr</span><span style=color:#111>({</span><span style=color:#d88200>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;result&#34;</span><span style=color:#111>]</span>
</span></span></code></pre></div><figure><img src=./retrieval_qa_refine_langsmith.png width=100%></figure><p>We can see that it invokes the refineDocumentsChain which involves four sequential calls to an LLM chain.</p><p>Inside each call, we will see that there is system message, user question and the answer. In the next call we will see that there is an additional user message behind the scenes saying " We have the opportunity to improve the existing answer if needed with some more context below". (Check langchain docs <code>refineDocumentsChain</code> for exact prompt).</p><p>This refine chain performs better than the map_reduce chain as it enables flow of information, albeit sequentially putting more context for the LLM.</p><p>But what we created so far, the system doesn&rsquo;t have a concept of state. It doesn&rsquo;t remember what we had asked, the history. Which brings us to the next and final step of the process.</p><h2 id=step-6---chat-with-memory>Step 6 - Chat (with memory)</h2><p>So far, we started with loading documents, splitting them, then we created embeddings and stored them in a vector store, we saw different ways of retrieval and shown that we can answer questions. For a fully functional chatbot, all that&rsquo;s left to do is to make sure we can have follow-up questions.</p><figure><img src=./chat_history_retrieval.png width=100%></figure><p>As we see above, we need to add a history component to maintain a conversation.</p><p>The interesting thing with langchain is that everything we&rsquo;ve seen up until this point is modular and we can add anything we want to the workflow as seen below.</p><figure><img src=./chat_history_modularity.png width=100%></figure><p>One of the ways to add memory is to use ConversationBufferMemory from LangChain</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.memory</span> <span style=color:#f92672>import</span> <span style=color:#111>ConversationBufferMemory</span>
</span></span><span style=display:flex><span><span style=color:#111>memory</span> <span style=color:#f92672>=</span> <span style=color:#111>ConversationBufferMemory</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>memory_key</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;chat_history&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>return_messages</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span></code></pre></div><p>What this does is keep a list, a buffer of chat messages in history and it&rsquo;s going pass those along with the question to the chatbot every time.</p><p>This can be used with a new type of chain, a ConversationalRetrievalChain. This chain adds a step to the retrieval QA chain process by taking the history and the new question and condensing it to a standalone question to be passed to the vector store to look up for documents.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chains</span> <span style=color:#f92672>import</span> <span style=color:#111>ConversationalRetrievalChain</span>
</span></span><span style=display:flex><span><span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>vectordb</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>qa</span> <span style=color:#f92672>=</span> <span style=color:#111>ConversationalRetrievalChain</span><span style=color:#f92672>.</span><span style=color:#111>from_llm</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>llm</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>retriever</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>memory</span><span style=color:#f92672>=</span><span style=color:#111>memory</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Is probability a class topic?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa</span><span style=color:#111>({</span><span style=color:#d88200>&#34;question&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#39;answer&#39;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>question</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;why are those prerequesites needed?&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>qa</span><span style=color:#111>({</span><span style=color:#d88200>&#34;question&#34;</span><span style=color:#111>:</span> <span style=color:#111>question</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#39;answer&#39;</span><span style=color:#111>]</span>
</span></span></code></pre></div><p>Using LangSmith, we can see the internal working of this chain.</p><figure><img src=./chat_history_langsmith.png width=100%></figure><p>We can see an additional component, chat history being invoked along with the original question.</p><p>Let&rsquo;s see the end-to-end code, from the beginning now:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.embeddings.openai</span> <span style=color:#f92672>import</span> <span style=color:#111>OpenAIEmbeddings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.text_splitter</span> <span style=color:#f92672>import</span> <span style=color:#111>CharacterTextSplitter</span><span style=color:#111>,</span> <span style=color:#111>RecursiveCharacterTextSplitter</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.vectorstores</span> <span style=color:#f92672>import</span> <span style=color:#111>DocArrayInMemorySearch</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>TextLoader</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chains</span> <span style=color:#f92672>import</span> <span style=color:#111>RetrievalQA</span><span style=color:#111>,</span>  <span style=color:#111>ConversationalRetrievalChain</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.memory</span> <span style=color:#f92672>import</span> <span style=color:#111>ConversationBufferMemory</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.chat_models</span> <span style=color:#f92672>import</span> <span style=color:#111>ChatOpenAI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>TextLoader</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>langchain.document_loaders</span> <span style=color:#f92672>import</span> <span style=color:#111>PyPDFLoader</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>load_db</span><span style=color:#111>(</span><span style=color:#111>file</span><span style=color:#111>,</span> <span style=color:#111>chain_type</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># load documents</span>
</span></span><span style=display:flex><span>    <span style=color:#111>loader</span> <span style=color:#f92672>=</span> <span style=color:#111>PyPDFLoader</span><span style=color:#111>(</span><span style=color:#111>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>documents</span> <span style=color:#f92672>=</span> <span style=color:#111>loader</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># split documents</span>
</span></span><span style=display:flex><span>    <span style=color:#111>text_splitter</span> <span style=color:#f92672>=</span> <span style=color:#111>RecursiveCharacterTextSplitter</span><span style=color:#111>(</span><span style=color:#111>chunk_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span><span style=color:#111>,</span> <span style=color:#111>chunk_overlap</span><span style=color:#f92672>=</span><span style=color:#ae81ff>150</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>docs</span> <span style=color:#f92672>=</span> <span style=color:#111>text_splitter</span><span style=color:#f92672>.</span><span style=color:#111>split_documents</span><span style=color:#111>(</span><span style=color:#111>documents</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># define embedding</span>
</span></span><span style=display:flex><span>    <span style=color:#111>embeddings</span> <span style=color:#f92672>=</span> <span style=color:#111>OpenAIEmbeddings</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># create vector database from data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>db</span> <span style=color:#f92672>=</span> <span style=color:#111>DocArrayInMemorySearch</span><span style=color:#f92672>.</span><span style=color:#111>from_documents</span><span style=color:#111>(</span><span style=color:#111>docs</span><span style=color:#111>,</span> <span style=color:#111>embeddings</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># define retriever</span>
</span></span><span style=display:flex><span>    <span style=color:#111>retriever</span> <span style=color:#f92672>=</span> <span style=color:#111>db</span><span style=color:#f92672>.</span><span style=color:#111>as_retriever</span><span style=color:#111>(</span><span style=color:#111>search_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;similarity&#34;</span><span style=color:#111>,</span> <span style=color:#111>search_kwargs</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#34;k&#34;</span><span style=color:#111>:</span> <span style=color:#111>k</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># create a chatbot chain. Memory is managed externally.</span>
</span></span><span style=display:flex><span>    <span style=color:#111>qa</span> <span style=color:#f92672>=</span> <span style=color:#111>ConversationalRetrievalChain</span><span style=color:#f92672>.</span><span style=color:#111>from_llm</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>llm</span><span style=color:#f92672>=</span><span style=color:#111>ChatOpenAI</span><span style=color:#111>(</span><span style=color:#111>model_name</span><span style=color:#f92672>=</span><span style=color:#111>llm_name</span><span style=color:#111>,</span> <span style=color:#111>temperature</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>),</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>chain_type</span><span style=color:#f92672>=</span><span style=color:#111>chain_type</span><span style=color:#111>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>retriever</span><span style=color:#f92672>=</span><span style=color:#111>retriever</span><span style=color:#111>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>return_source_documents</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#111>return_generated_question</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>qa</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>panel</span> <span style=color:#00a8c8>as</span> <span style=color:#111>pn</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>param</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>cbfs</span><span style=color:#111>(</span><span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>Parameterized</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>chat_history</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>List</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>answer</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>String</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>db_query</span>  <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>String</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>db_response</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>List</span><span style=color:#111>([])</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span>  <span style=color:#f92672>**</span><span style=color:#111>params</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>(</span><span style=color:#111>cbfs</span><span style=color:#111>,</span> <span style=color:#111>self</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>(</span> <span style=color:#f92672>**</span><span style=color:#111>params</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>panels</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>loaded_file</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;docs/cs229_lectures/MachineLearning-Lecture01.pdf&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>qa</span> <span style=color:#f92672>=</span> <span style=color:#111>load_db</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>loaded_file</span><span style=color:#111>,</span><span style=color:#d88200>&#34;stuff&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>call_load_db</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>count</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> <span style=color:#111>file_input</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>is</span> <span style=color:#00a8c8>None</span><span style=color:#111>:</span>  <span style=color:#75715e># init or no file specified :</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Loaded File: </span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>loaded_file</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>file_input</span><span style=color:#f92672>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#d88200>&#34;temp.pdf&#34;</span><span style=color:#111>)</span>  <span style=color:#75715e># local copy</span>
</span></span><span style=display:flex><span>            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>loaded_file</span> <span style=color:#f92672>=</span> <span style=color:#111>file_input</span><span style=color:#f92672>.</span><span style=color:#111>filename</span>
</span></span><span style=display:flex><span>            <span style=color:#111>button_load</span><span style=color:#f92672>.</span><span style=color:#111>button_style</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;outline&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>qa</span> <span style=color:#f92672>=</span> <span style=color:#111>load_db</span><span style=color:#111>(</span><span style=color:#d88200>&#34;temp.pdf&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;stuff&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>button_load</span><span style=color:#f92672>.</span><span style=color:#111>button_style</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;solid&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>clr_history</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Loaded File: </span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>loaded_file</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>convchain</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>query</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>query</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>WidgetBox</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#d88200>&#39;User:&#39;</span><span style=color:#111>,</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>)),</span> <span style=color:#111>scroll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>qa</span><span style=color:#111>({</span><span style=color:#d88200>&#34;question&#34;</span><span style=color:#111>:</span> <span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;chat_history&#34;</span><span style=color:#111>:</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>chat_history</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>chat_history</span><span style=color:#f92672>.</span><span style=color:#111>extend</span><span style=color:#111>([(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;answer&#34;</span><span style=color:#111>])])</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_query</span> <span style=color:#f92672>=</span> <span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;generated_question&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_response</span> <span style=color:#f92672>=</span> <span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#34;source_documents&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>answer</span> <span style=color:#f92672>=</span> <span style=color:#111>result</span><span style=color:#111>[</span><span style=color:#d88200>&#39;answer&#39;</span><span style=color:#111>]</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>panels</span><span style=color:#f92672>.</span><span style=color:#111>extend</span><span style=color:#111>([</span>
</span></span><span style=display:flex><span>            <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#d88200>&#39;User:&#39;</span><span style=color:#111>,</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>)),</span>
</span></span><span style=display:flex><span>            <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#d88200>&#39;ChatBot:&#39;</span><span style=color:#111>,</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>answer</span><span style=color:#111>,</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>,</span> <span style=color:#111>style</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;background-color&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>&#39;#F6F6F6&#39;</span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span>        <span style=color:#111>])</span>
</span></span><span style=display:flex><span>        <span style=color:#111>inp</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span>  <span style=color:#75715e>#clears loading indicator when cleared</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>WidgetBox</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>panels</span><span style=color:#111>,</span><span style=color:#111>scroll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@param.depends</span><span style=color:#111>(</span><span style=color:#d88200>&#39;db_query &#39;</span><span style=color:#111>,</span> <span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>get_lquest</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_query</span> <span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>                <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Last question to DB:&#34;</span><span style=color:#111>,</span> <span style=color:#111>styles</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;background-color&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>&#39;#F6F6F6&#39;</span><span style=color:#111>})),</span>
</span></span><span style=display:flex><span>                <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Str</span><span style=color:#111>(</span><span style=color:#d88200>&#34;no DB accesses so far&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>            <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;DB query:&#34;</span><span style=color:#111>,</span> <span style=color:#111>styles</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;background-color&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>&#39;#F6F6F6&#39;</span><span style=color:#111>})),</span>
</span></span><span style=display:flex><span>            <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Str</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_query</span> <span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@param.depends</span><span style=color:#111>(</span><span style=color:#d88200>&#39;db_response&#39;</span><span style=color:#111>,</span> <span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>get_sources</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_response</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>rlist</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Result of DB lookup:&#34;</span><span style=color:#111>,</span> <span style=color:#111>styles</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;background-color&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>&#39;#F6F6F6&#39;</span><span style=color:#111>}))]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>doc</span> <span style=color:#f92672>in</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>db_response</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>rlist</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Str</span><span style=color:#111>(</span><span style=color:#111>doc</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>WidgetBox</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>rlist</span><span style=color:#111>,</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>,</span> <span style=color:#111>scroll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@param.depends</span><span style=color:#111>(</span><span style=color:#d88200>&#39;convchain&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;clr_history&#39;</span><span style=color:#111>)</span> 
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>get_chats</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>chat_history</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>WidgetBox</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Str</span><span style=color:#111>(</span><span style=color:#d88200>&#34;No History Yet&#34;</span><span style=color:#111>)),</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>,</span> <span style=color:#111>scroll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>rlist</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Current Chat History variable&#34;</span><span style=color:#111>,</span> <span style=color:#111>styles</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;background-color&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>&#39;#F6F6F6&#39;</span><span style=color:#111>}))]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>exchange</span> <span style=color:#f92672>in</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>chat_history</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>rlist</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Str</span><span style=color:#111>(</span><span style=color:#111>exchange</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>WidgetBox</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>rlist</span><span style=color:#111>,</span> <span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>600</span><span style=color:#111>,</span> <span style=color:#111>scroll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>clr_history</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span><span style=color:#111>count</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>chat_history</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># in-notebook UI </span>
</span></span><span style=display:flex><span><span style=color:#111>cb</span> <span style=color:#f92672>=</span> <span style=color:#111>cbfs</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>file_input</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>widgets</span><span style=color:#f92672>.</span><span style=color:#111>FileInput</span><span style=color:#111>(</span><span style=color:#111>accept</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;.pdf&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>button_load</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>widgets</span><span style=color:#f92672>.</span><span style=color:#111>Button</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;Load DB&#34;</span><span style=color:#111>,</span> <span style=color:#111>button_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;primary&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>button_clearhistory</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>widgets</span><span style=color:#f92672>.</span><span style=color:#111>Button</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;Clear History&#34;</span><span style=color:#111>,</span> <span style=color:#111>button_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;warning&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>button_clearhistory</span><span style=color:#f92672>.</span><span style=color:#111>on_click</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>clr_history</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>inp</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>widgets</span><span style=color:#f92672>.</span><span style=color:#111>TextInput</span><span style=color:#111>(</span> <span style=color:#111>placeholder</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;Enter text hereâ€¦&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>bound_button_load</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>bind</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>call_load_db</span><span style=color:#111>,</span> <span style=color:#111>button_load</span><span style=color:#f92672>.</span><span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#111>clicks</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>conversation</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>bind</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>convchain</span><span style=color:#111>,</span> <span style=color:#111>inp</span><span style=color:#111>)</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>tab1</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>inp</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>layout</span><span style=color:#f92672>.</span><span style=color:#111>Divider</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>panel</span><span style=color:#111>(</span><span style=color:#111>conversation</span><span style=color:#111>,</span>  <span style=color:#111>loading_indicator</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span> <span style=color:#111>height</span><span style=color:#f92672>=</span><span style=color:#ae81ff>300</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>layout</span><span style=color:#f92672>.</span><span style=color:#111>Divider</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>tab2</span><span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>panel</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>get_lquest</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>layout</span><span style=color:#f92672>.</span><span style=color:#111>Divider</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>panel</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>get_sources</span> <span style=color:#111>),</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>tab3</span><span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>panel</span><span style=color:#111>(</span><span style=color:#111>cb</span><span style=color:#f92672>.</span><span style=color:#111>get_chats</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>layout</span><span style=color:#f92672>.</span><span style=color:#111>Divider</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>tab4</span><span style=color:#f92672>=</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span> <span style=color:#111>file_input</span><span style=color:#111>,</span> <span style=color:#111>button_load</span><span style=color:#111>,</span> <span style=color:#111>bound_button_load</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span> <span style=color:#111>button_clearhistory</span><span style=color:#111>,</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Clears chat history. Can use to start a new topic&#34;</span> <span style=color:#111>)),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>layout</span><span style=color:#f92672>.</span><span style=color:#111>Divider</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>jpg_pane</span><span style=color:#f92672>.</span><span style=color:#111>clone</span><span style=color:#111>(</span><span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#ae81ff>400</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dashboard</span> <span style=color:#f92672>=</span> <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Column</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Row</span><span style=color:#111>(</span><span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>pane</span><span style=color:#f92672>.</span><span style=color:#111>Markdown</span><span style=color:#111>(</span><span style=color:#d88200>&#39;# ChatWithYourData_Bot&#39;</span><span style=color:#111>)),</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pn</span><span style=color:#f92672>.</span><span style=color:#111>Tabs</span><span style=color:#111>((</span><span style=color:#d88200>&#39;Conversation&#39;</span><span style=color:#111>,</span> <span style=color:#111>tab1</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#d88200>&#39;Database&#39;</span><span style=color:#111>,</span> <span style=color:#111>tab2</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#d88200>&#39;Chat History&#39;</span><span style=color:#111>,</span> <span style=color:#111>tab3</span><span style=color:#111>),(</span><span style=color:#d88200>&#39;Configure&#39;</span><span style=color:#111>,</span> <span style=color:#111>tab4</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dashboard</span>
</span></span></code></pre></div></div></div></div></div><div class=container><div class="row justify-content-between"><div class=col-sm-4><p class=footer>Ritesh Panditi Â© 2024</p></div><div class="col-sm-6 d-flex flex-row-reverse"><a class="footer-social px-2" href=# target=_blank><i class="fab fa-twitter"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-github"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-medium-m"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-linkedin-in"></i></a></div></div></div><script src=/Digital-garden/js/bootstrap.min.js></script>
<script type=text/javascript src=/Digital-garden/js/jquery.min.js></script>
<script src=/Digital-garden/js/isotope.pkgd.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity=sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D crossorigin=anonymous async></script>
<script src=/Digital-garden/js/dark.js></script>
<script>var savedTheme=localStorage.getItem("dark-mode-storage")||"light";setTheme(savedTheme)</script><script src=/Digital-garden/js/isotope.js></script>
<script src=/Digital-garden/js/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><script src=/Digital-garden/js/tag_handler.js></script></body></html>