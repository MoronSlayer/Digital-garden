<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Frank+Ruhl+Libre:wght@200;300;400;500;600&family=Encode+Sans+Semi+Condensed:wght@400&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/Digital-garden/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/Digital-garden/css/all.min.css><link disabled id=dark-mode-theme rel=stylesheet href=/Digital-garden/css/dark.css><link rel=stylesheet type=text/css href=/Digital-garden/css/style.css><link rel=stylesheet type=text/css href=/Digital-garden/css/my_style.css><title>My Digital Garden | Data Engineering</title><meta name=description content="Notes from data engineering zoomcamp"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class=container><a class=navbar-brand href=https://ritesh1137.github.io/Digital-garden/><b style=font-weight:800>RP</b></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class=nav-link href=/Digital-garden/garden/>Digital Garden</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/projects/>Projects</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/library/>Library</a></li><li class=nav-item><a class=nav-link href=/Digital-garden/about/>About</a></li><li class="nav-item px-2 pt-1"><a class="btn fas fa-moon" id=dark-mode-toggle></a></li></ul></div></div></nav><div id=content><div class=container style=max-width:800px><div class="py-4 rounded-3"><div class="container-fluid py-2"><h1 class="display-2 mb-4 text-center">Data Engineering</h1></div><p class="text-center fs-4 fst-italic serif">Notes from data engineering zoomcamp</p><div class="text-center pt-4"></div></div><div class="row justify-content-center mb-5"><div class=col-12><p class="card-date m-0">Created Jan 25, 2024 -
Last updated: Jan 25, 2024</p><hr class=dropdown-divider><div class="row justify-content-between"><div class=col-sm-4><span class=status>Seeding ðŸŒ±</span></div><div class=col-sm-8 style=text-align:right><span onclick='handleTagClick("data","garden")' class="badge tag-badge">data</span></div></div></div></div><div class="container-fluid py-2"><div class="serif main-content"><p>The goal of this course is to build a data pipeline using TLC Trip Record data, which contains pickups and dropoffs of Taxis in NYC.
This is the architecture used in the course.</p><p><figure><img src=./architecture.jpeg width=100%></figure>Tools used as part of this course are:</p><ul><li><h4 id=dockerdocker><a href=#docker>Docker</a></h4></li><li><h4 id=postgressqlingesting-ny-taxi-data-to-postgres><a href=#ingesting-ny-taxi-data-to-postgres>PostgresSQL</a></h4></li><li><h4 id=pgadminconnecting-pgadmin-and-postgres><a href=#connecting-pgadmin-and-postgres>pgAdmin</a></h4></li></ul><h1 id=week-1>Week 1</h1><h3 id=docker>Docker</h3><p>Docker is a platform that uses containerization technology to simplify the process of developing, deploying, and running applications. By using Docker, you can package your application and its dependencies into a container, which can then run on any system that has Docker installed. This ensures consistency across environments and reduces the &ldquo;it works on my machine&rdquo; problem.</p><p>Key concepts in Docker include:</p><ol><li><p>Containers: These are lightweight, standalone, and executable packages that include everything needed to run an application: code, runtime, system tools, system libraries, and settings. Containers are isolated from one another and the host system.</p></li><li><p>Images: A Docker image is a read-only template used to create containers. Images are created with the docker build command, and they are based on a Dockerfile.</p></li><li><p>Dockerfile: This is a text file containing a series of instructions for Docker to build an image. It specifies the base image to use, the software to install, the files to add, and the commands to run.</p></li><li><p>Docker Hub: A cloud-based registry service where you can find and share container images with your team. It&rsquo;s similar to GitHub but for Docker images.</p></li><li><p>Volumes: These are used to persist and share data between a container and the host file system.</p></li><li><p>Docker Compose: A tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services, networks, and volumes, and then create and start all the services from your configuration with a single command.</p></li></ol><p>Docker simplifies the deployment process, ensures consistency, and is widely used in DevOps practices for continuous integration and continuous deployment (CI/CD) workflows.</p><h3 id=ingesting-ny-taxi-data-to-postgres>Ingesting NY Taxi Data to Postgres</h3><p>PostgreSQL, often referred to as Postgres, is an open-source, powerful, advanced, and feature-rich relational database management system (RDBMS). It is designed to handle a range of workloads, from single machines to data warehouses or web services with many concurrent users.</p><p>Firstly, the docker command required to run postgres locally:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker run -it <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>POSTGRES_USER</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>POSTGRES_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>POSTGRES_DB</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;ny_taxi&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -v <span style=color:#d88200>&#34;absolute_path_to_folder_where_you_want_database:/var/lib/postgresql/data&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -p 5432:5432 <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    postgres:13<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The -v flag is used for mapping a folder from host machine to a folder on our container, also called mounting. -e is environment flag, and port 5432 is used to connect external sources (here, our python script) to the database.</p><p>If the above code throws permission errors, use this code</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker volume create --name dtc_postgres_volume_local -d local<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>docker run -it<span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_USER</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_DB</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;ny_taxi&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -v dtc_postgres_volume_local:/var/lib/postgresql/data <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -p 5432:5432<span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  postgres:13<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Run the above code in your command line.</p><p>Now install pglci</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install pgcli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pgcli
</span></span></code></pre></div><p>then connect it using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgcli -h localhost -p <span style=color:#ae81ff>5432</span> -u root -d ny_taxi
</span></span></code></pre></div><p>Download data from <a href=https://github.com/DataTalksClub/nyc-tlc-data/releases/tag/yellow>here</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/DataTalksClub/nyc-tlc-data/releases/download/yellow/yellow_tripdata_2021-07.csv.gz
</span></span></code></pre></div><p>using the following python command, you can import and visualize the data</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># import libraries</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pandas</span> <span style=color:#00a8c8>as</span> <span style=color:#111>pd</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>sqlalchemy</span> <span style=color:#f92672>import</span> <span style=color:#111>create_engine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create engine and set the root as postgresql://user:password@host:port/database</span>
</span></span><span style=display:flex><span><span style=color:#111>engine</span> <span style=color:#f92672>=</span> <span style=color:#111>create_engine</span><span style=color:#111>(</span><span style=color:#d88200>&#39;postgresql://root:root@localhost:5432/ny_taxi&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>df_iter</span> <span style=color:#f92672>=</span> <span style=color:#111>pd</span><span style=color:#f92672>.</span><span style=color:#111>read_csv</span><span style=color:#111>(</span><span style=color:#d88200>&#39;yellow_tripdata_2021-07.csv.gz&#39;</span><span style=color:#111>,</span> <span style=color:#111>iterator</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span> <span style=color:#111>chunksize</span><span style=color:#f92672>=</span><span style=color:#ae81ff>100000</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>while</span> <span style=color:#00a8c8>True</span><span style=color:#111>:</span> <span style=color:#75715e>#iterate and read chunks of data and append it to the table</span>
</span></span><span style=display:flex><span>    <span style=color:#111>df</span> <span style=color:#f92672>=</span> <span style=color:#111>next</span><span style=color:#111>(</span><span style=color:#111>df_iter</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>df</span><span style=color:#f92672>.</span><span style=color:#111>tpep_pickup_datetime</span> <span style=color:#f92672>=</span> <span style=color:#111>pd</span><span style=color:#f92672>.</span><span style=color:#111>to_datetime</span><span style=color:#111>(</span><span style=color:#111>df</span><span style=color:#f92672>.</span><span style=color:#111>tpep_pickup_datetime</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>df</span><span style=color:#f92672>.</span><span style=color:#111>tpep_dropoff_datetime</span> <span style=color:#f92672>=</span> <span style=color:#111>pd</span><span style=color:#f92672>.</span><span style=color:#111>to_datetime</span><span style=color:#111>(</span><span style=color:#111>df</span><span style=color:#f92672>.</span><span style=color:#111>tpep_dropoff_datetime</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>df</span><span style=color:#f92672>.</span><span style=color:#111>to_sql</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;yellow_taxi_data&#39;</span><span style=color:#111>,</span> <span style=color:#111>con</span><span style=color:#f92672>=</span><span style=color:#111>engine</span><span style=color:#111>,</span> <span style=color:#111>if_exists</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;append&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Then using <code>\dt</code> command, we can view the tables in the database, and using <code>\d yellow_taxi_data</code>, we see the imported data schema.</p><figure><img src=./dt_command.png width=100%></figure><p>We can also run SQL queries in pgcli as show below:</p><figure><img src=./pgcli_queries.jpg width=100%></figure><p>The maximum amount of money a customer had to pay was $1320.8 ?!</p><h3 id=connecting-pgadmin-and-postgres>Connecting pgAdmin and Postgres</h3><p>We see that pgcli is good but not very convenient as it is part of the command line interface. For ease of use, we have a web based GUI tool called pgAdmin.</p><p>We can find the docker image for pgAdmin 4 (current version, 2024) from <a href=https://www.pgadmin.org/download/pgadmin-4-container/>here</a> or in the docker hub <a href=https://hub.docker.com/r/dpage/pgadmin4/>here</a>.</p><blockquote><p>(use <code>ctrl</code>+<code>D</code> or <code>quit</code> command to quit pgcli in your terminal)</p></blockquote><p>This is the docker command to run pgAdmin:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker run -it <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PGADMIN_DEFAULT_EMAIL</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;admin@admin.com&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PGADMIN_DEFAULT_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -p <span style=color:#d88200>&#34;8080:80&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -d dpage/pgadmin4<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The first two environment variables set default email and password for logging in, then the -p flag maps port 8080 from our host machine to port 80 on the container.pgAdmin will be running and listening for requests on port 80, so all requests we send to our host machine&rsquo;s port 8080 will be forwarded to port 80 on the container.</p><figure><img src=./pgAdmin_docker.png width=100%></figure><p>This will open up port 8080 on our local host machine and can be accessed from our browser.</p><figure><img src=./localHost8080.png width=100%></figure><p><code>right click</code> on Servers, <code>click</code> Register and add your new server.</p><figure><img src=./server_register.png width=100%></figure><p>But when we try to establish a connection, we get an error</p><figure><img src=./server_error.png width=100%></figure><p>This is because our postgres/localhost is in one container and pgAdmin is running in a different container. We need to link these two, the database and pgAdmin by putting both these containers in a Docker network.</p><figure><img src=./docker_network.png width=100%></figure><p>We do this by closing our container with the database and pgAdmin, then creating a docker network by the command</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker network create pg-network<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><figure><img src=./docker_network_cli.png width=100%></figure><p>Then reinitializing the database container with our network using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker volume create --name dtc_postgres_volume_local -d local<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>docker run -it<span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_USER</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -e <span style=color:#111>POSTGRES_DB</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;ny_taxi&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -v dtc_postgres_volume_local:/var/lib/postgresql/data <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  -p 5432:5432<span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --network<span style=color:#f92672>=</span>pg-network <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --name pg-database <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  postgres:13<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We also add pgAdmin to our network</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker run -it <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PGADMIN_DEFAULT_EMAIL</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;admin@admin.com&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PGADMIN_DEFAULT_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;root&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -p <span style=color:#d88200>&#34;8080:80&#34;</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    --network<span style=color:#f92672>=</span>pg-network <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    --name pgadmin-2 <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -d dpage/pgadmin4<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Once we run the above command, we can restart localhost:8080 and register our new server with the host name we set to our database pg-network (see above).</p><figure><img src=./server_register2.png width=100%></figure><p>We are now connected to our database using pgAdmin and can view and query it. Let&rsquo;s see the first 100 rows, go to</p><p>Databases &ndash;> Schemas &ndash;> Tables &ndash;> Yellow_taxi_data, right click &ndash;> View/Edit Data &ndash;> First 100 rows</p><figure><img src=./first100.png width=100%></figure><h3 id=dockerizing-the-ingestion-script>Dockerizing the Ingestion Script</h3><p>Now, we convert the ipynb file to a script, using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> <span style=color:#111>jupyter</span> <span style=color:#111>nbconvert</span> <span style=color:#f92672>--</span><span style=color:#111>to</span><span style=color:#f92672>=</span><span style=color:#111>script</span> <span style=color:#111>upload_data</span><span style=color:#f92672>.</span><span style=color:#111>ipynb</span>
</span></span></code></pre></div><p>We do this so that we can create a data ingestion pipeline using argparse in python, downloading the data and inserting the data into the table using a script.</p><p>We add the argarse and convert the notebook to an ingestion script, as seen in ingest_script.py.</p><p>We can now drop the table from pgAdmin using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#00a8c8>DROP</span> <span style=color:#00a8c8>TABLE</span> <span style=color:#111>yellow_taxi_data</span> 
</span></span></code></pre></div><p>and run the script to see if it&rsquo;s working.</p><p>We can now use the following script from the command line to run the data ingestion pipeline, downloading data and creating a table using ingest_data.py .</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#111>URL</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;https://github.com/DataTalksClub/nyc-tlc-data/releases/download/yellow/yellow_tripdata_2021-07.csv.gz&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>python3 ingest_data.py <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --user<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --password<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --host<span style=color:#f92672>=</span>localhost <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --db<span style=color:#f92672>=</span>ny_taxi <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --table_name<span style=color:#f92672>=</span>yellow_taxi_trips <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --url<span style=color:#f92672>=</span><span style=color:#d88200>${</span><span style=color:#111>URL</span><span style=color:#d88200>}</span>
</span></span></code></pre></div><p>Now, we will dockerize this ingestion process by creating a Dockerfile in our working directory:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Docker data-lang=Docker><span style=display:flex><span><span style=color:#00a8c8>FROM</span><span style=color:#d88200> python:3.9.1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#00a8c8>RUN</span> apt-get install wget<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#00a8c8>RUN</span> pip install pandas sqlalchemy psycopg2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#00a8c8>WORKDIR</span><span style=color:#d88200> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#00a8c8>COPY</span> ingest_data.py ingest_data.py <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#00a8c8>ENTRYPOINT</span> <span style=color:#111>[</span> <span style=color:#d88200>&#34;python&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;ingest_data.py&#34;</span> <span style=color:#111>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>and then running this in our command line:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t taxi_ingestion:v001 .
</span></span></code></pre></div><p>Once it&rsquo;s built, we create a docker script to run the ingestion pipeline using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker run -it <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span> --network<span style=color:#f92672>=</span>pg-network <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span> taxi_ingestion:v001 <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --user<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --password<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --host<span style=color:#f92672>=</span>pg-database <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --db<span style=color:#f92672>=</span>ny_taxi <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --table_name<span style=color:#f92672>=</span>yellow_taxi_trips <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --url<span style=color:#f92672>=</span><span style=color:#d88200>${</span><span style=color:#111>URL</span><span style=color:#d88200>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=running-postgres-and-pgadmin-with-docker-compose>Running Postgres and pgAdmin with Docker compose</h3><p>Previously, we run postgres and pgAdmin in one Docker network and there was a lot of configuration to be done. So instead of using two docker commands, we can specify a single YAML file that will help us do this task.</p><p>We create a compose-docker.yaml file as shown below</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  pgdatabase:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: postgres:13<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    environment:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_USER</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_PASSWORD</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_DB</span><span style=color:#f92672>=</span>ny_taxi<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    volumes:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#d88200>&#34;./ny_taxi_postgres_data:/var/lib/postgresql/data:rw&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ports:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#d88200>&#34;5432:5432&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  pgadmin:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: dpage/pgadmin4<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    environment:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>PGADMIN_DEFAULT_EMAIL</span><span style=color:#f92672>=</span>admin@admin.com<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>PGADMIN_DEFAULT_PASSWORD</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ports:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#d88200>&#34;8080:80&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now, pgdatabase will be the name we can access postgres with and both postgres and pgadmin will be in the same network as we are using docker compose, no need for creating another network.</p><p>Now, we stop the containers with postgres and pgadmin.</p><p>Ensure nothing is running with <code>docker ps</code> and use <code>docker kill &lt;containerID></code> to stop any container you want.</p><p>We can now run <code>docker-compose up</code> to run docker compose using our YAML file and configure both pgadmin and postgres.</p><p>Running <code>docker-compose up</code>and restarting localhost:8080 created problems in my system when trying to create a new server, as there were problems with postgres.
Specificially, a local bind ./ny_taxi_postgres_data seemed to throwing a permissions error, to resolve this, we can change the docker-compose.YAML file as follows:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  pgdatabase:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: postgres:13<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    environment:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_USER</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_PASSWORD</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>POSTGRES_DB</span><span style=color:#f92672>=</span>ny_taxi<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    volumes:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - dtc_postgres_volume_local:/var/lib/postgresql/data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ports:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#d88200>&#34;5432:5432&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  pgadmin:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: dpage/pgadmin4<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    environment:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>PGADMIN_DEFAULT_EMAIL</span><span style=color:#f92672>=</span>admin@admin.com<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#111>PGADMIN_DEFAULT_PASSWORD</span><span style=color:#f92672>=</span>root<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ports:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#d88200>&#34;8080:80&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>volumes:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    dtc_postgres_volume_local:<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Here, instead of using a bind mount from a local directory ("./ny_taxi_postgres_data:/var/lib/postgresql/data:rw"), we use a named volume that is actually present in a docker container, this resolves the permission errors and we can now access the database from pgAdmin.</p><p>However, here I was unable to access the table after connecting to pgAdmin, so I had to reingest the data using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#111>URL</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;https://github.com/DataTalksClub/nyc-tlc-data/releases/download/yellow/yellow_tripdata_2021-07.csv.gz&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>docker run -it <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span> --network<span style=color:#f92672>=</span>docker_sql_default <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span> taxi_ingestion:v001 <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --user<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --password<span style=color:#f92672>=</span>root <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --host<span style=color:#f92672>=</span>pgdatabase <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --db<span style=color:#f92672>=</span>ny_taxi <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --table_name<span style=color:#f92672>=</span>yellow_taxi_trips <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>  --url<span style=color:#f92672>=</span><span style=color:#d88200>${</span><span style=color:#111>URL</span><span style=color:#d88200>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>docker_sql_default is the name from system when running docker-compose up and the new host is pgdatabase as specified in our YAML file.</p><figure><img src=./docker_compose_up.png width=100%></figure><p>We can also run docker compose in detached mode using</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker-compose up -d <span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>where we will be able to use the terminal after running it.</p><p>To shut it down, use</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>docker-compose down<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div></div></div><div class=container><div class="row justify-content-between"><div class=col-sm-4><p class=footer>Ritesh Panditi Â© 2024</p></div><div class="col-sm-6 d-flex flex-row-reverse"><a class="footer-social px-2" href=# target=_blank><i class="fab fa-twitter"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-github"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-medium-m"></i></a>
<a class="footer-social px-2" href=# target=_blank><i class="fab fa-linkedin-in"></i></a></div></div></div><script src=/Digital-garden/js/bootstrap.min.js></script>
<script type=text/javascript src=/Digital-garden/js/jquery.min.js></script>
<script src=/Digital-garden/js/isotope.pkgd.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity=sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D crossorigin=anonymous async></script>
<script src=/Digital-garden/js/dark.js></script>
<script>var savedTheme=localStorage.getItem("dark-mode-storage")||"light";setTheme(savedTheme)</script><script src=/Digital-garden/js/isotope.js></script>
<script src=/Digital-garden/js/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><script src=/Digital-garden/js/tag_handler.js></script></body></html>